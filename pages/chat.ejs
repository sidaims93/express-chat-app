
<%- include('./layouts/head') %>
    <div class="container" style="max-width: 1500px !important;">
        <div class="row clearfix">
            <div class="col-lg-12">
                <div class="card chat-app">
                    
                    <% if(locals.userAccount && userAccount !== null) { %>
                        <input type="hidden" value="<%= userAccount.id %>" id="user_id">
                        <input type="hidden" value="<%= userAccount.default_channel %>" id="default_channel">
                        <input type="hidden" value="<%= userAccount.receive_message_channel %>" id="receive_message_channel">
                    <% } %>
                    
                    <input type="hidden" name="recipient_id" id="recipient_id" <% if(locals.lastUser) { %> value="<%= lastUser.id %>" <% } %>>
                    <% if (locals.sidebar && sidebar.length > 0) { %>
                        <%- include('./layouts/sidebar', {sidebar: sidebar, usersArr: usersArr}) %>
                    <% } %>
                    
                    <div class="chat">
                    <% if(locals.sidebar && sidebar.length > 0) { %>
                        <div class="chat-header clearfix">
                            <div class="row">
                                <div class="col-lg-6">
                                    <a href="javascript:void(0);" data-toggle="modal" data-target="#view_info">
                                        <img <% if(lastUser !== null) { %> src="<%= lastUser.avatar %>" <% } %> alt="avatar">
                                    </a>
                                    <div class="chat-about">
                                        <h6 class="m-b-0">
                                            <% if(lastUser !== null) { %> <%= lastUser.name %> <% } %>
                                        </h6>
                                        
                                        <small>Last seen: 2 hours ago</small>
                                    </div>
                                </div>
                                <div class="col-lg-6 hidden-sm text-right">
                                    <a href="javascript:void(0);" class="btn btn-outline-secondary"><i class="fa fa-camera"></i></a>
                                    <a href="javascript:void(0);" class="btn btn-outline-primary"><i class="fa fa-image"></i></a>
                                    <a href="javascript:void(0);" class="btn btn-outline-info"><i class="fa fa-cogs"></i></a>
                                    <a href="/logout" class="btn btn-outline-danger"><i class="fa fa-stop"></i></a>
                                </div>
                            </div>
                        </div>
                        <div class="chat-history">
                            <ul class="m-b-0" id="message-box">
                                <% if(locals.lastChatHistory && lastChatHistory !== null) { %>
                                <% for(var i in lastChatHistory) { %>
                                    <li class="clearfix">
                                        <% if(lastChatHistory[i].message && lastChatHistory[i].message.length > 0) { %>
                                            <div class="message-data <% if(lastChatHistory[i].user_id === userAccount.id) { %> text-right <% } %>">
                                                <span class="message-data-time"><%= lastChatHistory[i].created_at.toLocaleString('en-US') %></span>
                                                <img src="<%= userAccount.avatar %>" alt="avatar">
                                            </div>
                                            <div class="message other-message <% if(lastChatHistory[i].user_id === userAccount.id) { %> float-right <% } %>"> <%= lastChatHistory[i].message %> </div>
                                        <% } else { %>
                                            <div class="container text-center" style="width:50%">
                                                <span style="font-size: 0.75rem;">You started the conversation on <%= lastChatHistory[i].created_at.toLocaleString() %></span>
                                            </div>
                                        <% } %>
                                    </li>
                                <% } %>
                                <% } %>
                            </ul>
                        </div>
                        <div class="chat-message clearfix">
                            <div class="input-group mb-0">
                                <input id="message" type="text" class="form-control" placeholder="Enter message here...">
                                <div class="input-group-prepend" id="send_button">
                                    <span class="input-group-text btn-primary"><i class="fa fa-angle-double-right" style="cursor: pointer;"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% } else { %>
                        <div class="chat-header clearfix">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="chat-about">
                                        <h6 class="m-b-0">Start new chat</h6>
                                    </div>
                                </div>
                                <div class="col-lg-6 hidden-sm text-right">
                                    <a href="javascript:void(0);" class="btn btn-outline-secondary"><i class="fa fa-camera"></i></a>
                                    <a href="javascript:void(0);" class="btn btn-outline-primary"><i class="fa fa-image"></i></a>
                                    <a href="javascript:void(0);" class="btn btn-outline-info"><i class="fa fa-cogs"></i></a>
                                    <a href="/logout" class="btn btn-outline-danger"><i class="fa fa-stop"></i></a>
                                </div>
                            </div>
                        </div>
                        <div class="chat-history">
                            <h5>Please select any user from the list</h5><br><br>
                            <table class="table-responsive">
                                <tbody>
                                    <tr>
                                        <% for(var i in usersArr) { %>
                                            <td>
                                                <div class="about" style="padding:25px 25px 25px 25px">
                                                    <div class="name"><%= usersArr[i].name %></div>
                                                    <a href="/start_chat/<%= usersArr[i].id %>" class="btn btn-success">Start Chat</a>
                                                </div>
                                            </td>
                                        <% } %>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    <% } %>    
                </div>
            </div>
        </div>
    </div>
    <%- include('./layouts/scripts') %>
    <script>
        $(document).ready(function () {
            $('#send_button').click(function (e) {
                e.preventDefault();
                var el = $('#user_id')
                var user_id = el.val();
                var recipient_id = $('#recipient_id').val();
                var message = $('#message').val();
                if(message.length < 1) {
                    alert('Please enter text');
                    el.val('');
                    return false;
                } else {
                    var obj = {
                        message: message, 
                        user_id: user_id, 
                        recipient_id: recipient_id
                    }
                    $.ajax({
                        url: '/post/message',
                        type: 'POST',
                        data: obj,
                        async: false,
                        success: function (response) {
                            var html = `
                                <li>
                                    <div class="message-data text-right">
                                        <span class="message-data-time">${new Date().toLocaleString()}</span>
                                        <img src="<%= userAccount.avatar %>" alt="avatar">
                                    </div>
                                    <div class="message other-message float-right"> ${message} </div>
                                </li>
                            `;
                            $('#message-box').append(html);
                        } 
                    });

                    el.val('');
                }
            })
        })
    </script>
<%- include('./layouts/footer') %>